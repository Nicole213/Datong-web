# 盘点作业添加物料功能说明

## 更新时间
2024年

## 功能概述

在盘点作业页面中，点击【添加物料】按钮后，会在物料明细表格的最后一行显示可编辑的输入行，用户可以填写物料编码或物料名称，系统会自动验证并关联物料信息。

## 功能特点

### 1. 表格内添加
- 点击"添加物料"按钮后，在表格最后一行显示添加行
- 添加行背景色为浅绿色（#e8f5e9），边框为绿色（#52c41a）
- 包含确认和取消按钮

### 2. 物料编码/名称关联
- **只填物料编码**：
  - 输入物料编码后失焦或按回车
  - 系统验证物料是否存在于物料管理中
  - 验证通过后自动带出物料名称和图片
  - 聚焦到盘点数量输入框
  
- **只填物料名称**：
  - 输入物料名称后失焦或按回车
  - 系统验证物料是否存在于物料管理中
  - 验证通过后自动带出物料编码和图片
  - 聚焦到盘点数量输入框

- **两者只需填一个**：
  - 物料编码和名称只需填写其中一个
  - 另一个会自动带出
  - 如果两者都填写，以先填写的为准

### 3. 数据验证

#### 物料编码验证
- 不能为空
- 必须存在于物料管理中
- 不能与容器中已有物料重复

#### 物料名称验证
- 不能为空
- 必须存在于物料管理中
- 不能与容器中已有物料重复

#### 编码名称匹配验证
- 确认添加时验证编码和名称是否匹配
- 必须是同一个物料的编码和名称

#### 盘点数量验证
- 不能小于0
- 必须为整数

### 4. 添加流程

```
1. 点击"添加物料"按钮
   ↓
2. 表格最后显示添加行
   ↓
3. 输入物料编码或名称
   ↓
4. 系统验证并自动关联
   ↓
5. 填写盘点数量
   ↓
6. 点击"确认添加"
   ↓
7. 系统验证所有信息
   ↓
8. 添加成功，显示在表格中
```

## 界面设计

### 添加行结构
```
┌──────────────────────────────────────────────────────────────────────────┐
│ 物料编码输入框 │ 物料名称输入框 │ 图片 │ 需要盘点 │ 0 │ 盘点数量 │ - │ [✓][✕] │
└──────────────────────────────────────────────────────────────────────────┘
```

### 按钮设计
- **确认按钮（✓）**：
  - 绿色圆形按钮（32x32px）
  - 背景色：#52c41a
  - 白色对勾图标
  - 悬停时放大1.1倍
  
- **取消按钮（✕）**：
  - 红色圆形按钮（32x32px）
  - 背景色：#ff4d4f
  - 白色叉号图标
  - 悬停时放大1.1倍

- **按钮布局**：
  - 显示在最后一列（盘点结果列）
  - 水平排列，间距6px
  - 居中对齐
  - 支持鼠标悬停提示

### 输入框样式
- 边框：2px solid #52c41a（绿色）
- 聚焦时：边框颜色 #389e0d，阴影效果
- 占位符：灰色提示文字
- 宽度：100%填充单元格

### 按钮样式
- **确认添加（✓）**：绿色圆形按钮（#52c41a），白色对勾图标
- **取消（✕）**：红色圆形按钮（#ff4d4f），白色叉号图标
- 悬停效果：放大1.1倍
- 尺寸：32x32px
- 位置：显示在最后一列（盘点结果列）

## 交互细节

### 1. 输入框聚焦
- 点击"添加物料"后自动聚焦到物料编码输入框
- 物料编码验证通过后自动聚焦到盘点数量输入框
- 物料名称验证通过后自动聚焦到盘点数量输入框

### 2. 回车键支持
- 物料编码输入框支持回车键触发验证
- 物料名称输入框支持回车键触发验证
- 回车后自动进行验证和关联

### 3. 失焦验证
- 物料编码输入框失焦时自动验证
- 物料名称输入框失焦时自动验证
- 验证失败时清空输入并重新聚焦

### 4. 状态控制
- 添加状态标志：`isAddingMaterial`
- 添加状态下不能再次点击"添加物料"
- 必须确认或取消当前添加才能继续

### 5. 自动计算
- 添加物料时账面数量固定为0
- 填写盘点数量后自动计算差异
- 自动判断盘点结果（盘盈/正常）

## 错误提示

### 1. 物料编码不存在
```
物料编码不存在！请检查物料管理中是否有该物料。
```

### 2. 物料名称不存在
```
物料名称不存在！请检查物料管理中是否有该物料。
```

### 3. 物料已存在
```
该物料已存在于容器中！
```

### 4. 编码名称不匹配
```
物料编码和名称不匹配！请检查输入。
```

### 5. 未填写必填项
```
请输入物料编码！
请输入物料名称！
```

### 6. 数量验证失败
```
盘点数量不能小于0！
```

### 7. 正在添加中
```
请先完成当前物料的添加！
```

## 成功提示

添加成功后显示：
```
物料 [物料名称] 已添加！
账面数量：0
盘点数量：[填写的数量]
盘点结果：[盘盈/正常]
```

## 数据结构

### 物料主数据
```javascript
const masterMaterials = [
    { code: 'WL-2024-001', name: '电子元件A型', image: '📦' },
    { code: 'WL-2024-002', name: '机械零件B型', image: '⚙️' },
    { code: 'WL-2024-003', name: '塑料配件C型', image: '🔧' },
    { code: 'WL-2024-004', name: '橡胶密封圈D型', image: '⭕' },
    { code: 'WL-2024-005', name: '金属材料E型', image: '🔩' }
];
```

### 添加的物料对象
```javascript
{
    code: '物料编码',
    name: '物料名称',
    image: '物料图标',
    needInventory: true,
    bookQty: 0,
    countQty: 填写的盘点数量,
    difference: 盘点数量 - 0,
    result: '盘盈' 或 '正常'
}
```

## 技术实现

### 1. 状态管理
```javascript
let isAddingMaterial = false; // 是否正在添加物料
```

### 2. 核心函数

#### addMaterial()
- 设置添加状态
- 重新渲染表格显示添加行

#### handleMaterialCodeBlur(code)
- 验证物料编码
- 自动关联物料名称和图片

#### handleMaterialNameBlur(name)
- 验证物料名称
- 自动关联物料编码和图片

#### confirmAddMaterial()
- 验证所有输入
- 添加物料到容器
- 重新渲染表格

#### cancelAddMaterial()
- 取消添加状态
- 重新渲染表格

### 3. 渲染逻辑
- 渲染现有物料
- 如果正在添加，渲染添加行
- 添加行包含输入框和按钮
- 自动聚焦到物料编码输入框

## 测试场景

### 场景1：通过物料编码添加
1. 点击"添加物料"按钮
2. 输入物料编码：WL-2024-004
3. 失焦或按回车
4. 系统自动填充名称：橡胶密封圈D型
5. 填写盘点数量：10
6. 点击"确认添加"
7. 添加成功

### 场景2：通过物料名称添加
1. 点击"添加物料"按钮
2. 跳过物料编码，直接输入物料名称：金属材料E型
3. 失焦或按回车
4. 系统自动填充编码：WL-2024-005
5. 填写盘点数量：5
6. 点击"确认添加"
7. 添加成功

### 场景3：物料编码不存在
1. 点击"添加物料"按钮
2. 输入物料编码：WL-9999
3. 失焦或按回车
4. 系统提示：物料编码不存在
5. 输入框清空并重新聚焦

### 场景4：物料已存在
1. 点击"添加物料"按钮
2. 输入物料编码：WL-2024-001（容器中已有）
3. 失焦或按回车
4. 系统提示：该物料已存在于容器中
5. 输入框清空并重新聚焦

### 场景5：编码名称不匹配
1. 点击"添加物料"按钮
2. 输入物料编码：WL-2024-001
3. 手动修改物料名称为：机械零件B型
4. 点击"确认添加"
5. 系统提示：物料编码和名称不匹配

### 场景6：取消添加
1. 点击"添加物料"按钮
2. 输入部分信息
3. 点击"取消"按钮
4. 添加行消失，返回正常状态

## 优化建议

### 1. 功能增强
- 支持扫码枪快速输入
- 支持模糊搜索物料
- 支持批量添加物料
- 支持从历史记录选择

### 2. 用户体验
- 添加物料时显示可选物料列表
- 输入时显示自动完成建议
- 添加成功后高亮显示新物料
- 支持快捷键操作

### 3. 数据验证
- 实时验证输入
- 显示验证状态图标
- 提供更详细的错误信息
- 支持多语言提示

## 注意事项

1. 物料编码和名称只需填写一个，另一个会自动关联
2. 必须确保物料存在于物料管理中
3. 不能添加容器中已存在的物料
4. 添加的物料账面数量固定为0
5. 添加状态下不能重复点击"添加物料"按钮
6. 必须确认或取消当前添加才能继续其他操作
7. 输入框支持回车键快速操作
8. 验证失败时会清空输入并重新聚焦

## 总结

盘点作业的添加物料功能已优化为表格内添加模式，支持通过物料编码或名称自动关联，提供了完善的数据验证和友好的用户交互。用户只需填写物料编码或名称其中之一，系统会自动关联另一个字段，大大提升了操作效率和准确性。
