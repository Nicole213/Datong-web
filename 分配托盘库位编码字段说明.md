# 分配托盘库位编码字段说明

## 修改内容

已在入库单页面的"分配托盘"弹窗和"自定义分配托盘"弹窗中添加"库位编码"字段，显示容器当前所在的库位位置。

## 修改前后对比

### 1. 推荐托盘列表

#### 修改前
- ☐ 复选框
- 容器编码
- 当前存储物料明细
- 推荐存储物料
- 推荐存储数量

#### 修改后
- ☐ 复选框
- 容器编码
- 当前存储物料明细
- **库位编码** ← 新增字段
- 推荐存储物料
- 推荐存储数量

### 2. 自定义分配托盘列表

#### 修改前
- ☐ 复选框
- 容器编码
- 当前存储物料明细
- 可用容量

#### 修改后
- ☐ 复选框
- 容器编码
- 当前存储物料明细
- **库位编码** ← 新增字段
- 可用容量

## 字段说明

### 库位编码
- **类型：** 文本
- **格式：** 
  - 库位格式：排-列-层-深（例如：1-3-8-1）
  - 入库口格式：入库口X（例如：入库口1）
- **说明：** 显示容器当前所在的位置
- **显示规则：**
  - 容器在库位上：显示库位编码（如：1-3-8-1）
  - 容器在入库口：显示入库口名称（如：入库口1）
  - 无位置信息：显示"-"

## 界面变化

### 推荐托盘列表
```
┌──┬──────────┬──────────────────┬──────────┬──────────────┬──────────┐
│☐│容器编码  │当前存储物料明细  │库位编码  │推荐存储物料  │推荐数量  │
├──┼──────────┼──────────────────┼──────────┼──────────────┼──────────┤
│☐│RK-2024-001│电子元件A型×30    │1-3-8-1   │[WL-2024-001▼]│[20]      │
│☐│RK-2024-002│空托盘            │入库口1   │[WL-2024-003▼]│[50]      │
│☐│RK-2024-003│机械零件B型×15... │2-5-10-1  │[WL-2024-005▼]│[25]      │
└──┴──────────┴──────────────────┴──────────┴──────────────┴──────────┘
```

### 自定义分配托盘列表
```
┌──┬──────────┬──────────────────┬──────────┬──────────┐
│☐│容器编码  │当前存储物料明细  │库位编码  │可用容量  │
├──┼──────────┼──────────────────┼──────────┼──────────┤
│☐│RK-2024-010│塑料配件C型×20... │1-8-12-2  │22        │
│☐│RK-2024-011│空托盘            │入库口2   │50        │
│☐│RK-2024-012│电子元件A型×10... │3-2-6-1   │23        │
└──┴──────────┴──────────────────┴──────────┴──────────┘
```

## 代码修改

### 1. HTML表格结构（pages/入库单.html）

#### 推荐托盘列表
**修改前：**
```html
<thead>
    <tr>
        <th width="50"><input type="checkbox" id="selectAllPallets"></th>
        <th>容器编码</th>
        <th>当前存储物料明细</th>
        <th>推荐存储物料</th>
        <th>推荐存储数量</th>
    </tr>
</thead>
```

**修改后：**
```html
<thead>
    <tr>
        <th width="50"><input type="checkbox" id="selectAllPallets"></th>
        <th>容器编码</th>
        <th>当前存储物料明细</th>
        <th>库位编码</th>
        <th>推荐存储物料</th>
        <th>推荐存储数量</th>
    </tr>
</thead>
```

#### 自定义分配托盘列表
**修改前：**
```html
<thead>
    <tr>
        <th width="50"><input type="checkbox" id="selectAllCustomPallets"></th>
        <th>容器编码</th>
        <th>当前存储物料明细</th>
        <th>可用容量</th>
    </tr>
</thead>
```

**修改后：**
```html
<thead>
    <tr>
        <th width="50"><input type="checkbox" id="selectAllCustomPallets"></th>
        <th>容器编码</th>
        <th>当前存储物料明细</th>
        <th>库位编码</th>
        <th>可用容量</th>
    </tr>
</thead>
```

### 2. 托盘数据结构（scripts/inbound.js）

**修改前：**
```javascript
const availablePallets = [
    { 
        id: 1, 
        code: 'RK-2024-001', 
        currentMaterials: '电子元件A型 × 30', 
        availableCapacity: 20, 
        recommended: true,
        defaultMaterial: 'WL-2024-001',
        defaultQuantity: 20
    }
];
```

**修改后：**
```javascript
const availablePallets = [
    { 
        id: 1, 
        code: 'RK-2024-001', 
        currentMaterials: '电子元件A型 × 30',
        locationCode: '1-3-8-1',  // 新增：库位编码
        availableCapacity: 20, 
        recommended: true,
        defaultMaterial: 'WL-2024-001',
        defaultQuantity: 20
    }
];
```

### 3. 渲染推荐托盘列表（renderRecommendPallets函数）

**修改前：**
```javascript
return `
    <tr>
        <td><input type="checkbox" class="pallet-checkbox" value="${pallet.id}"></td>
        <td>${pallet.code}</td>
        <td>${pallet.currentMaterials}</td>
        <td>
            <select class="form-input pallet-material-select">...</select>
        </td>
        <td>
            <input type="number" class="form-input pallet-qty-input">
        </td>
    </tr>
`;
```

**修改后：**
```javascript
return `
    <tr>
        <td><input type="checkbox" class="pallet-checkbox" value="${pallet.id}"></td>
        <td>${pallet.code}</td>
        <td>${pallet.currentMaterials}</td>
        <td>${pallet.locationCode || '-'}</td>
        <td>
            <select class="form-input pallet-material-select">...</select>
        </td>
        <td>
            <input type="number" class="form-input pallet-qty-input">
        </td>
    </tr>
`;
```

### 4. 渲染自定义分配托盘列表（openCustomAllocateModal函数）

**修改前：**
```javascript
tbody.innerHTML = customPallets.map(pallet => `
    <tr>
        <td><input type="checkbox" class="custom-pallet-checkbox" value="${pallet.id}"></td>
        <td>${pallet.code}</td>
        <td>${pallet.currentMaterials}</td>
        <td>${pallet.availableCapacity}</td>
    </tr>
`).join('');
```

**修改后：**
```javascript
tbody.innerHTML = customPallets.map(pallet => `
    <tr>
        <td><input type="checkbox" class="custom-pallet-checkbox" value="${pallet.id}"></td>
        <td>${pallet.code}</td>
        <td>${pallet.currentMaterials}</td>
        <td>${pallet.locationCode || '-'}</td>
        <td>${pallet.availableCapacity}</td>
    </tr>
`).join('');
```

## 测试数据

### 推荐托盘（3个）
1. **RK-2024-001**
   - 当前存储：电子元件A型 × 30
   - 库位编码：1-3-8-1
   - 推荐物料：WL-2024-001
   - 推荐数量：20

2. **RK-2024-002**
   - 当前存储：空托盘
   - 库位编码：入库口1
   - 推荐物料：WL-2024-003
   - 推荐数量：50

3. **RK-2024-003**
   - 当前存储：机械零件B型 × 15、塑料配件C型 × 10
   - 库位编码：2-5-10-1
   - 推荐物料：WL-2024-005
   - 推荐数量：25

### 自定义分配托盘（3个）
1. **RK-2024-010**
   - 当前存储：塑料配件C型 × 20、金属材料E型 × 8
   - 库位编码：1-8-12-2
   - 可用容量：22

2. **RK-2024-011**
   - 当前存储：空托盘
   - 库位编码：入库口2
   - 可用容量：50

3. **RK-2024-012**
   - 当前存储：电子元件A型 × 10、机械零件B型 × 12、金属材料E型 × 5
   - 库位编码：3-2-6-1
   - 可用容量：23

## 测试验证

### 测试步骤

1. 打开入库单页面
2. 点击某个入库单的"分配托盘"按钮
3. 查看推荐托盘列表
4. 验证"库位编码"列是否显示：
   - ✅ RK-2024-001 显示 1-3-8-1
   - ✅ RK-2024-002 显示 入库口1
   - ✅ RK-2024-003 显示 2-5-10-1
5. 点击"自定义分配"按钮
6. 查看自定义分配托盘列表
7. 验证"库位编码"列是否显示：
   - ✅ RK-2024-010 显示 1-8-12-2
   - ✅ RK-2024-011 显示 入库口2
   - ✅ RK-2024-012 显示 3-2-6-1

### 预期结果

- ✅ 推荐托盘列表正确显示库位编码
- ✅ 自定义分配托盘列表正确显示库位编码
- ✅ 库位编码格式正确（排-列-层-深 或 入库口X）
- ✅ 无库位信息时显示"-"
- ✅ 表格布局正常，没有错位

## 业务价值

### 1. 提高操作效率
- ✅ 操作员可以快速了解容器当前位置
- ✅ 便于判断容器是否需要移动
- ✅ 减少查找容器的时间

### 2. 优化分配决策
- ✅ 根据容器位置选择合适的托盘
- ✅ 优先选择距离近的容器
- ✅ 减少不必要的搬运

### 3. 提升可追溯性
- ✅ 记录容器在分配时的位置
- ✅ 便于追溯容器移动轨迹
- ✅ 支持库存盘点和审计

### 4. 辅助问题排查
- ✅ 快速定位容器位置
- ✅ 发现异常位置的容器
- ✅ 支持库位管理优化

## 使用场景

### 场景1：选择就近容器
操作员在分配托盘时，可以查看容器的库位编码，优先选择距离入库口较近的容器，减少搬运距离。

### 场景2：识别入库口容器
通过库位编码可以快速识别哪些容器已经在入库口等待，可以优先分配这些容器。

### 场景3：避免重复移动
如果容器已经在目标库位附近，可以优先分配，避免重复移动。

### 场景4：库位规划
根据容器当前位置分布，可以优化库位分配策略，提高仓储效率。

## 相关文件

- **HTML：** `pages/入库单.html` - 更新了两个表格的表头
- **JavaScript：** `scripts/inbound.js` - 更新了以下内容：
  - 托盘数据结构（添加 locationCode 字段）
  - renderRecommendPallets 函数（添加库位编码列）
  - openCustomAllocateModal 函数（添加库位编码列）

## 向后兼容

### 已有数据处理
- ✅ 如果托盘数据中没有 `locationCode` 字段，显示"-"
- ✅ 不影响其他功能的正常使用
- ✅ 可以逐步补充库位编码数据

### 其他功能影响
- ✅ 不影响分配托盘的核心逻辑
- ✅ 不影响确认分配功能
- ✅ 不影响入库作业功能

## 后续优化建议

1. **库位高亮：** 在库位地图上高亮显示选中容器的位置
2. **距离计算：** 计算并显示容器到入库口的距离
3. **智能排序：** 根据库位距离自动排序推荐托盘
4. **库位筛选：** 支持按库位范围筛选容器
5. **路径规划：** 显示容器搬运的最优路径

## 状态

✅ **已完成** - 库位编码字段已添加，可正常使用
