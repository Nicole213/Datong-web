# 库存明细功能说明

## 功能概述

库存明细页面是库存管理模块的核心功能，提供了完整的库存查询、管理和导出能力。页面以**物料+容器**维度展示库存数据，支持多维度查询、物料锁定/解锁、清空库存和数据导出等操作。

## 菜单位置

**一级菜单：** 库存管理 📦  
**二级菜单：** 库存明细

## 页面布局

### 1. 查询筛选区
支持以下筛选条件：
- **物料编码/名称**：模糊搜索，支持输入物料编码或物料名称
- **容器编码**：模糊搜索容器编码
- **库存状态**：下拉选择（全部/正常/锁定）
- **库位信息**：支持按排、列、层、深四个维度精确查询

### 2. 操作按钮区
- **🔒 物料锁定**：锁定选中的物料，锁定后不可出库
- **🔓 物料解锁**：解锁选中的物料，恢复正常出库
- **🗑️ 清空库存**：清空选中的库存记录（不可恢复）
- **📥 导出**：导出当前查询结果为CSV文件

### 3. 表格区
展示字段：
- 物料编码
- 物料名称
- 容器编码
- 容器类型
- 库位编码（排-列-层-深格式）
- 库区
- 库存数量
- 组盘时间
- 入库时间
- 库龄(天)
- 库存状态

## 核心功能

### 1. 多维度查询

**功能说明：**
- 支持按物料编码/名称模糊搜索
- 支持按容器编码模糊搜索
- 支持按库位的排、列、层、深精确查询
- 支持按库存状态筛选
- 多个条件可组合使用

**使用场景：**
- 查询某个物料在所有容器中的库存分布
- 查询某个容器中的所有物料
- 查询某个库位上的所有库存
- 查询所有锁定状态的库存

### 2. 物料锁定/解锁

**功能说明：**
- 可批量选择多条记录进行锁定或解锁
- 锁定后的物料状态显示为"锁定"（红色标签）
- 正常状态的物料显示为"正常"（绿色标签）

**业务规则：**
- 锁定的物料不可出库
- 如果容器中只有部分物料被锁定，容器可以出库，但锁定的物料不可出库
- 已锁定的物料不能重复锁定
- 正常状态的物料不能解锁

**使用场景：**
- 质量问题物料需要暂时锁定，等待处理
- 预留物料，防止被其他订单出库
- 盘点期间锁定部分库存

### 3. 清空库存

**功能说明：**
- 可批量选择多条记录进行清空
- 清空前会显示详细的物料信息确认
- 清空操作不可恢复

**业务规则：**
- 清空是按物料+容器维度进行的
- 清空某个容器中的某个物料，不影响该容器中的其他物料
- 清空后记录从系统中删除

**使用场景：**
- 报废物料的库存清理
- 盘点差异调整
- 错误数据的清理

### 4. 数据导出

**功能说明：**
- 导出当前查询结果为CSV文件
- 文件名格式：库存明细_YYYYMMDD_HHMMSS.csv
- 支持中文（UTF-8 BOM编码）

**导出内容：**
- 包含所有表格列的数据
- 导出的是当前筛选后的数据，不是全部数据

**使用场景：**
- 库存报表生成
- 数据分析
- 与其他系统对接

### 5. 库龄显示

**功能说明：**
- 自动计算库存的库龄（从入库时间到当前的天数）
- 用颜色标识不同的库龄范围

**颜色规则：**
- **绿色**：≤15天（新鲜库存）
- **黄色**：16-30天（需要关注）
- **红色**：>30天（库存积压）

**使用场景：**
- 快速识别库存积压情况
- 先进先出管理
- 库存周转分析

## 数据维度说明

### 物料+容器维度

库存明细以**物料+容器**维度展示数据，这意味着：

**示例：**
容器TP-001中存放了2种物料：
- WL-2024-001（电子元件A型）30件
- WL-2024-002（机械零件B型）20件

在库存明细列表中会显示为**2条记录**：

| 物料编码 | 物料名称 | 容器编码 | 数量 | 状态 |
|---------|---------|---------|------|------|
| WL-2024-001 | 电子元件A型 | TP-001 | 30 | 正常 |
| WL-2024-002 | 机械零件B型 | TP-001 | 20 | 正常 |

**优势：**
- 可以对同一容器中的不同物料进行独立管理
- 支持物料级别的锁定和解锁
- 便于按物料维度统计库存

## 操作流程

### 查询库存
1. 在筛选区输入查询条件
2. 点击【查询】按钮
3. 查看查询结果
4. 点击【重置】可清空所有筛选条件

### 锁定物料
1. 勾选需要锁定的库存记录（可多选）
2. 点击【物料锁定】按钮
3. 在确认对话框中点击"确定"
4. 锁定成功后，记录状态变为"锁定"

### 解锁物料
1. 筛选出锁定状态的记录
2. 勾选需要解锁的记录（可多选）
3. 点击【物料解锁】按钮
4. 在确认对话框中点击"确定"
5. 解锁成功后，记录状态变为"正常"

### 清空库存
1. 勾选需要清空的库存记录（可多选）
2. 点击【清空库存】按钮
3. 在确认对话框中查看将要清空的物料明细
4. 确认无误后点击"确定"
5. 记录从列表中删除

### 导出数据
1. 可选：先进行筛选，只导出需要的数据
2. 点击【导出】按钮
3. 浏览器自动下载CSV文件
4. 使用Excel或其他工具打开文件

## 业务场景示例

### 场景1：查询某个物料的库存分布
**需求：** 查看物料WL-2024-001在所有容器中的分布情况

**操作步骤：**
1. 在"物料编码/名称"输入框中输入"WL-2024-001"
2. 点击【查询】
3. 查看结果，可以看到该物料在哪些容器中，每个容器的数量

### 场景2：锁定质量问题物料
**需求：** 容器TP-003中的塑料配件C型发现质量问题，需要锁定

**操作步骤：**
1. 在"容器编码"输入框中输入"TP-003"
2. 点击【查询】
3. 勾选塑料配件C型的记录
4. 点击【物料锁定】
5. 确认锁定

**结果：** 该物料被锁定，不可出库，但容器中的其他物料（如果有）不受影响

### 场景3：清理报废物料
**需求：** 容器TP-005中的长物料钢材D型已报废，需要清空库存

**操作步骤：**
1. 在"容器编码"输入框中输入"TP-005"
2. 点击【查询】
3. 勾选长物料钢材D型的记录
4. 点击【清空库存】
5. 在确认对话框中查看物料信息
6. 确认无误后点击"确定"

**结果：** 该物料的库存记录被删除

### 场景4：导出库存报表
**需求：** 导出库区A的所有库存数据

**操作步骤：**
1. 在"排"输入框中输入"1"（假设库区A的排号为1）
2. 点击【查询】
3. 点击【导出】按钮
4. 下载CSV文件

**结果：** 获得库区A的库存明细Excel文件

### 场景5：识别库存积压
**需求：** 查找库龄超过30天的库存

**操作步骤：**
1. 不设置任何筛选条件，显示所有库存
2. 观察"库龄(天)"列，红色数字表示超过30天
3. 可以按库龄排序（如果需要）
4. 对积压库存采取相应措施

## 注意事项

### 1. 数据维度
- ✅ 库存明细以**物料+容器**维度展示
- ✅ 一个容器有多种物料时会显示多条记录
- ✅ 每条记录代表一个容器中的一种物料

### 2. 锁定/解锁
- ✅ 锁定是针对单条记录的，不影响同一容器中的其他物料
- ✅ 锁定的物料不可出库
- ✅ 容器未锁定时可以出库，但锁定的物料不可出库
- ⚠️ 已锁定的物料不能重复锁定
- ⚠️ 正常状态的物料不能解锁

### 3. 清空库存
- ⚠️ 清空操作**不可恢复**，请谨慎操作
- ✅ 清空前会显示详细的物料信息供确认
- ✅ 清空是按物料+容器维度进行的

### 4. 导出功能
- ✅ 导出的是**当前筛选结果**，不是全部数据
- ✅ 文件格式为CSV，支持中文
- ✅ 可以用Excel直接打开

### 5. 分页
- ✅ 每页显示10条记录
- ✅ 切换页面时会清空选中状态
- ✅ 清空库存后如果当前页没有数据，自动返回上一页

## 技术实现

### 文件结构
```
pages/库存明细.html          # 页面HTML
scripts/inventory-detail.js  # 页面逻辑
styles/inventory-detail.css  # 页面样式
```

### 数据结构
```javascript
{
    id: 1,                              // 记录ID
    materialCode: 'WL-2024-001',        // 物料编码
    materialName: '电子元件A型',         // 物料名称
    containerCode: 'TP-001',            // 容器编码
    containerType: '小金属框',           // 容器类型
    locationCode: '1-1-5-1',            // 库位编码
    area: '库区A',                      // 库区
    quantity: 30,                       // 库存数量
    palletTime: '2024-01-10 09:30:00', // 组盘时间
    inboundTime: '2024-01-10 10:15:00',// 入库时间
    age: 25,                            // 库龄(天)
    status: '正常'                      // 库存状态
}
```

### 核心函数
- `searchInventory()` - 查询库存
- `lockMaterials()` - 物料锁定
- `unlockMaterials()` - 物料解锁
- `clearInventory()` - 清空库存
- `exportData()` - 导出数据

## 测试说明

详细的测试场景和步骤请参考：`测试库存明细.html`

测试文件包含：
- 11个测试场景
- 详细的测试步骤
- 预期结果说明
- 业务规则验证
- 注意事项说明

## 更新记录

### 2024年2月
- ✅ 创建库存明细页面
- ✅ 实现多维度查询功能
- ✅ 实现物料锁定/解锁功能
- ✅ 实现清空库存功能
- ✅ 实现数据导出功能
- ✅ 实现库龄颜色标识
- ✅ 添加测试文件和文档

## 后续优化建议

### 功能增强
- [ ] 支持批量导入库存数据
- [ ] 支持库存调整功能
- [ ] 支持库存预警设置
- [ ] 支持库存冻结（区别于锁定）
- [ ] 支持库存转移功能

### 性能优化
- [ ] 大数据量时的分页优化
- [ ] 查询性能优化
- [ ] 导出大数据量时的性能优化

### 用户体验
- [ ] 支持列排序
- [ ] 支持列筛选
- [ ] 支持自定义列显示
- [ ] 支持保存查询条件
- [ ] 支持快捷查询模板

## 联系方式

如有问题或建议，请联系系统管理员。
