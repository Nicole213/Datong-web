# 分配托盘验证逻辑说明

## 修改内容

已修改"确认分配"按钮的验证逻辑，改为验证推荐托盘列表中所有有数据的托盘，而不是只验证勾选的托盘。

## 新的验证逻辑

### ✅ 修改前（旧逻辑）
- 必须勾选托盘的复选框
- 只验证已勾选的托盘
- 已勾选的托盘必须填写物料和数量

### ✅ 修改后（新逻辑）
- **不需要勾选复选框**
- 验证推荐托盘列表中的所有托盘
- 只要"推荐存储物料"和"推荐存储数量"不为空，就会被分配
- 至少需要一个托盘有有效数据

## 验证规则

### 1. 必填项验证
- ✅ 必须选择入库口
- ✅ 至少一个托盘有有效的物料和数量数据

### 2. 托盘数据验证
对于推荐托盘列表中的每个托盘：
- 如果"推荐存储物料"不为空 **且** "推荐存储数量"大于0
  - ✅ 该托盘会被分配
- 如果"推荐存储物料"为空 **或** "推荐存储数量"为0或空
  - ⏭️ 该托盘会被跳过（不分配）

### 3. 数量验证
- 推荐存储数量必须大于0
- 推荐存储数量不能超过该物料的待入库数量

## 使用场景示例

### 场景1：默认推荐托盘
```
推荐托盘列表：
☐ RK-2024-001 | 电子元件A型×30 | [WL-2024-001-电子元件A型] | [20]
☐ RK-2024-002 | 空托盘        | [WL-2024-003-塑料配件C型] | [50]
☐ RK-2024-003 | 机械零件B型×15 | [WL-2024-005-金属材料E型] | [25]
```

**操作：** 直接点击"确认分配"（不勾选任何复选框）

**结果：** ✅ 成功分配3个托盘
- RK-2024-001 分配 WL-2024-001 × 20
- RK-2024-002 分配 WL-2024-003 × 50
- RK-2024-003 分配 WL-2024-005 × 25

---

### 场景2：部分托盘有数据
```
推荐托盘列表：
☐ RK-2024-001 | 电子元件A型×30 | [WL-2024-001-电子元件A型] | [20]
☐ RK-2024-002 | 空托盘        | [请选择物料]              | [50]
☐ RK-2024-003 | 机械零件B型×15 | [WL-2024-005-金属材料E型] | [25]
```

**操作：** 点击"确认分配"

**结果：** ✅ 成功分配2个托盘
- RK-2024-001 分配 WL-2024-001 × 20
- RK-2024-002 跳过（物料未选择）
- RK-2024-003 分配 WL-2024-005 × 25

---

### 场景3：修改推荐数据
```
推荐托盘列表：
☐ RK-2024-001 | 电子元件A型×30 | [WL-2024-003-塑料配件C型] | [30]  ← 修改了物料和数量
☐ RK-2024-002 | 空托盘        | [请选择物料]              | [0]
☐ RK-2024-003 | 机械零件B型×15 | [WL-2024-005-金属材料E型] | [25]
```

**操作：** 点击"确认分配"

**结果：** ✅ 成功分配2个托盘
- RK-2024-001 分配 WL-2024-003 × 30（使用修改后的数据）
- RK-2024-002 跳过（物料未选择）
- RK-2024-003 分配 WL-2024-005 × 25

---

### 场景4：所有托盘都为空
```
推荐托盘列表：
☐ RK-2024-001 | 电子元件A型×30 | [请选择物料] | [0]
☐ RK-2024-002 | 空托盘        | [请选择物料] | [0]
☐ RK-2024-003 | 机械零件B型×15 | [请选择物料] | [0]
```

**操作：** 点击"确认分配"

**结果：** ❌ 提示"请至少为一个托盘选择物料并填写数量！"

---

## 代码实现

### 核心验证逻辑
```javascript
// 从推荐托盘列表中收集所有有效的分配数据（不管是否勾选）
const allocations = [];
const tbody = document.getElementById('recommendPalletBody');
const rows = tbody.querySelectorAll('tr');

rows.forEach(row => {
    const materialSelect = row.querySelector('.pallet-material-select');
    const qtyInput = row.querySelector('.pallet-qty-input');
    
    if (materialSelect && qtyInput) {
        const materialCode = materialSelect.value;
        const quantity = parseInt(qtyInput.value) || 0;
        
        // 如果物料和数量都不为空，则添加到分配列表
        if (materialCode && quantity > 0) {
            const palletId = parseInt(materialSelect.dataset.palletId);
            allocations.push({
                palletId: palletId,
                materialCode: materialCode,
                quantity: quantity
            });
        }
    }
});

// 验证是否有有效的分配数据
if (allocations.length === 0) {
    alert('请至少为一个托盘选择物料并填写数量！');
    return;
}
```

### 验证流程
```
点击"确认分配"按钮
    ↓
验证入库口是否选择
    ↓
遍历推荐托盘列表的所有行
    ↓
对每一行：
    - 获取"推荐存储物料"的值
    - 获取"推荐存储数量"的值
    - 如果物料不为空 且 数量>0
        → 添加到分配列表
    - 否则
        → 跳过该托盘
    ↓
检查分配列表是否为空
    - 如果为空 → 提示错误
    - 如果不为空 → 执行分配
    ↓
更新物料入库数量
    ↓
更新订单状态
    ↓
显示成功提示
```

## 优势

### ✅ 1. 更灵活
- 不需要勾选复选框
- 用户可以直接填写数据后点击确认

### ✅ 2. 更直观
- 只要填写了物料和数量，就会被分配
- 空的托盘会自动跳过

### ✅ 3. 更高效
- 减少了勾选复选框的操作步骤
- 默认推荐的托盘可以直接分配

### ✅ 4. 更智能
- 自动过滤无效数据
- 只分配有效的托盘

## 测试验证

### 测试步骤
1. 打开 `pages/index.html`
2. 点击"入库管理" → "入库单"
3. 找到 RK-2024-0003 记录
4. 点击"分配托盘"按钮
5. 查看推荐托盘列表（3个托盘都有默认物料和数量）
6. **不勾选任何复选框**，直接点击"确认分配"
7. 验证是否成功分配

### 预期结果
- ✅ 成功分配3个托盘
- ✅ 提示"已分配托盘数：3"
- ✅ 订单状态变为"入库中"
- ✅ 物料的已入库数量更新

### 测试场景
1. **场景1：** 默认数据，不勾选，直接确认 → 应该成功
2. **场景2：** 清空一个托盘的物料，确认 → 应该分配2个托盘
3. **场景3：** 修改物料和数量，确认 → 应该使用修改后的数据
4. **场景4：** 清空所有托盘，确认 → 应该提示错误

## 相关文件

- **JavaScript：** `scripts/inbound.js` - confirmAllocate 函数（第1050-1090行）
- **HTML：** `pages/入库单.html` - 分配托盘弹窗
- **测试页面：** `test-allocate.html` - 快速测试

## 修改记录

- **修改时间：** 2024-01-31
- **修改内容：** 改变验证逻辑，从验证勾选的托盘改为验证所有有数据的托盘
- **影响范围：** confirmAllocate 函数
- **向后兼容：** ✅ 是（原有功能仍然可用）

## 状态

✅ **已完成** - 新的验证逻辑已实现并可正常使用
